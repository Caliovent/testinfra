#!/bin/bash
apt-get update
apt-get install -y nginx openssl

# 1. Préparation du dossier SSL
mkdir -p /etc/nginx/ssl

# -----------------------------------------------------------------------------
# ÉCRITURE DES CERTIFICATS EXISTANTS
# Remplacez les blocs ci-dessous par le contenu réel de vos fichiers.
# -----------------------------------------------------------------------------

# A. Écriture de la Clé Privée (.key)
cat > /etc/nginx/ssl/nginx.key <<'EOFKEY'
${ssl_key}
EOFKEY

# B. Écriture du Certificat + CA (.crt)
cat > /etc/nginx/ssl/nginx.crt <<'EOFCERT'
${ssl_crt}
EOFCERT

# -----------------------------------------------------------------------------
# CONFIGURATION NGINX
# -----------------------------------------------------------------------------

# Configuration Nginx pour écouter en HTTPS (443) et forcer TLS 1.2
cat > /etc/nginx/sites-available/default <<EOF
server {
    listen 80;
    listen 443 ssl;
    
    # Chemins vers les fichiers créés ci-dessus
    ssl_certificate /etc/nginx/ssl/nginx.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.key;
    
    # SÉCURITÉ : Forcer TLS 1.2 uniquement
    ssl_protocols TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        add_header Content-Type text/plain;
        return 200 'Backend TLS 1.2 valid certificate :) Nice.';
    }
}
EOF

# 3. Redémarrage pour appliquer la config
systemctl restart nginx