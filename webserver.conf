#!/bin/bash
apt-get update
apt-get install -y nginx openssl

# 1. Préparation du dossier SSL
mkdir -p /etc/nginx/ssl

# -----------------------------------------------------------------------------
# ÉCRITURE DES CERTIFICATS EXISTANTS
# Remplacez les blocs ci-dessous par le contenu réel de vos fichiers.
# -----------------------------------------------------------------------------

# A. Écriture de la Clé Privée (.key)
# Collez ici le contenu de votre fichier .key ou .pem (Private Key)
cat > /etc/nginx/ssl/nginx.key <<'EOFKEY'
-----BEGIN PRIVATE KEY-----
MIIEowIBAAKCAQEAluvD2yGGiWbxtrsCfSC1W9m9ADpBIQrxLgsMzHmiIV5ba1SB
u4QXNIDhQZ5fYUxJ86+UdokvSZqhX8UXCUzIKSjRSsNV6b08Yo6C7I0RIEwGZBHX
eyHvU3E5aia134elX/j7vXM38sHi01a64Ffu2RsehtV5iI1PikKKkXfBDN3EMpkG
ikHCtet7AKbJcXmKv1MThL2xBtnV9rnDT05Q7mXbIidvp+MC8l1fkjAIYTNq6ZDj
fkSu1kiNrm98VS5c6mEpaFhEM6LTuRnTOsjhFrQED8GhA+HdONHAOOAl2S7IEFSl
LnVqJSYxqxo/On4NRhKegv66EPZeRWtXx1Ss4wIDAQABAoIBABSYhiObIVC8/hLm
1dcc+0MBUEaorIda2+u2/FR8lkChhNj9MQXVvT5KsZ2ShF0IhosSlLB8gOSK4qeU
LlRJky3yxmUX39tEb5TaR/RfkqJqsvCTHWn4s+rE59tG/x5LKlQSQXXq3wwU+ORz
JeZEecb3vs8TG5Z5WmJ5juQn3e49sP8k/65iWbKpINRhL8KW8WNgmOwrp+HVa4L1
joxj3z511RqsJ+tEyXhy3knO2YRrD+LKjXo6BAM4F7VnaEqAPkvJRIEaoqE0S6pE
q4+Esr6fmUTM5Aqpvk6oHVD8XMD0nUGkMWTDBqE/HJ98fnpmJJ3uaudxQSmMxV8M
T5gFGJECgYEA0j7xv1CA90iAvQwDQXt/+v7ZCsdlxfiXl8/e6EN7erqBMzS79Jjz
LLRY6JusOxpUtc0Ljiav0FaXO2FMBuQJaIfiiWDdyBDPCIrpyfAX89ZwT7/3HsGm
c5UE3G1rmfvmp8hguYTIK62E01EiZvutpQyUQo/Rke35nIxyGBUK/YkCgYEAt8PB
uM16h+ds3++3DtUHLW4eEUQ9TmddbOIePXv6WQgdr8jSZ19Kr6aghMJeRFpYlm5c
vMZqxqruLWacNh6gVAPvSfKIEdUirK4ds/gMH6Nx6lxXu5EAOEp0OWVCVDOSRjWm
Q4KLuV6I6w65DhlWabEZ4q9rdm2GbdKIuHgTiAsCgYAr/sPzttLl7CQUazkbMM69
JSsh2Evxu21tdTA+BjEGo5R5tKVIL+FjD3IzarAFxiLH0FqEqo/L1vLamCeioYFe
gGDlQoHmZa4NKZR2j2lTuyHRbmg15WwBb8OOpM8Jb+76WTH0YFbK3QqYdbfvOOdD
THiR3SqLkPLU0YbmhzC/kQKBgGtcmkSvAASAp/JZafjnau8W48gwtySkbUfc/8/q
LARyIm3+BTdRzB+9WRDXQh3rLtCMn+/GeMGjQc4SofdYg1Eyj04DvY21mTGL9Fyd
8e9WHYrP8o3qFFfO4AJcb5kkHDSayY2tqpZdbd7u1h0vnnXXe4kd9cnWCXEGTMyB
kt+rAoGBAIBDEGzKPgN2oagQDFw0CMOROF2ZpsulHsCfSRyuYs55VENRpu6qzQIi
IhAUTEAY/szTitcZyTlfLom+cFo+IKuVSf4bJgxyaqu+LoIz+DM2/SG9b9yi16nv
Y4upRUYkFrR2tWApREsUjks1sAbDZwwd25vQgpFxER7OsoyBYx/I
-----END PRIVATE KEY-----
EOFKEY

# B. Écriture du Certificat + CA (.crt)
# Collez d'abord votre certificat serveur, PUIS le certificat CA à la suite.
cat > /etc/nginx/ssl/nginx.crt <<'EOFCERT'
-----BEGIN CERTIFICATE-----
MIIDmjCCAoKgAwIBAgIITCDiY1R5ouswDQYJKoZIhvcNAQELBQAwADAeFw0yNjAx
MDUxNDM0MDBaFw0yNzAxMDUxNDM0MDBaMFsxETAPBgNVBAoTCEZvcnRpbmV0MQww
CgYDVQQLEwNUQUMxEjAQBgNVBAMTCXdlYnNlcnZlcjEkMCIGCSqGSIb3DQEJARYV
dnNjaG1pdHRAZm9ydGluZXQuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEAluvD2yGGiWbxtrsCfSC1W9m9ADpBIQrxLgsMzHmiIV5ba1SBu4QXNIDh
QZ5fYUxJ86+UdokvSZqhX8UXCUzIKSjRSsNV6b08Yo6C7I0RIEwGZBHXeyHvU3E5
aia134elX/j7vXM38sHi01a64Ffu2RsehtV5iI1PikKKkXfBDN3EMpkGikHCtet7
AKbJcXmKv1MThL2xBtnV9rnDT05Q7mXbIidvp+MC8l1fkjAIYTNq6ZDjfkSu1kiN
rm98VS5c6mEpaFhEM6LTuRnTOsjhFrQED8GhA+HdONHAOOAl2S7IEFSlLnVqJSYx
qxo/On4NRhKegv66EPZeRWtXx1Ss4wIDAQABo4G8MIG5MAwGA1UdEwEB/wQCMAAw
HQYDVR0OBBYEFMU+PeAmPiO9L6qxpK7D2Yo6ZUXoMB8GA1UdIwQYMBaAFEc/0eN3
JnmYrUdBubkbTNf3qBScMAsGA1UdDwQEAwID6DATBgNVHSUEDDAKBggrBgEFBQcD
ATAUBgNVHREEDTALggl3ZWJzZXJ2ZXIwEQYJYIZIAYb4QgEBBAQDAgZAMB4GCWCG
SAGG+EIBDQQRFg94Y2EgY2VydGlmaWNhdGUwDQYJKoZIhvcNAQELBQADggEBAGH0
d8N3xUF7nWJmxqlTX3ba54EzAsyNz6eIAfhenmZl/RNFqwjaU/ukudJRucfq3EYM
RHUzxRIP5EEJHT/2QL2QNA+5/EtgVD7uNEkyBWZkA7cr40uh4w+7tmj9DYTS1bR2
vcQ2WaG2KWZtNGPWfGsmVIg+LgkiuZOhzW/mtmKpAdd4i8BPSkWe5u49O8xmTFGM
B47rbP54La0Lsa52vJBQDI3OhkEvvX54LjdRA7hoKY/BFJ4iElGd0Q0Yqct2G36Y
dgTGslJWCA787Lfi5SpeLZNxwgs/zaQ7lz24Ol6q7IGNHrMElliGgsQOYJmdoeE8
yWBqWpg5GfdQ9L30vIQ=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIC9DCCAdygAwIBAgIILKmGZ42jqekwDQYJKoZIhvcNAQELBQAwADAeFw0yNjAx
MDUxNDMzMDBaFw0zNjAxMDUxNDMzMDBaMAAwggEiMA0GCSqGSIb3DQEBAQUAA4IB
DwAwggEKAoIBAQDgozgON9Ue8/VEAbuT2ND5f0QlSMIguws19Oh7d3hmfC5k4era
HO7mK48hX91uQHCHFC7npR6GqcA5tvfEpLCJsPQov280QdLWCP0L/No441EeMDgp
eBk9hLcRib903yul/l5MqH1p3O8aYfGjqkVazkx03gaPKDN9a1Eiwr0qzluEkWkU
pqCi9uW3Y8uzEwDruFf4WVFPEWS4RzhOX0bbs4A2fPfTuNF7FFdhYq18M7no36EP
Ri8rzSjBUfLJp5ng+Nf0v2yW3Z7OWGfAw6AxrHABmmbIX/si2tiXTpDUWryHZvbJ
inkgqtDjcziqEbVqz9eta1DztxCnRypWibCVAgMBAAGjcjBwMA8GA1UdEwEB/wQF
MAMBAf8wHQYDVR0OBBYEFEc/0eN3JnmYrUdBubkbTNf3qBScMAsGA1UdDwQEAwIB
BjARBglghkgBhvhCAQEEBAMCAAcwHgYJYIZIAYb4QgENBBEWD3hjYSBjZXJ0aWZp
Y2F0ZTANBgkqhkiG9w0BAQsFAAOCAQEASlNRiSiZjN83CLpfpLZaBf6wanpjlElr
FF9HeH4KFdTuHbnVdZ+pIA2IbwDd960RCnqYt5Jw1v6IY9KTQnkJaPqQhqM5d6CZ
ulgwvcqiSSvwZ0iTkpoLNuCfFZ22O5tTTXbyAHd+6a5vOvjNx/qbt6eWdupEx9vx
UQQPylbB39/Y58R2gSa0dQeV9x3wXaTRCjH0/lOs0MYISdYyms2v7wb5O9so7+ld
8wII1o5JX8RmCA+YuIcbjPKsLhzLlCFb+WwBtuVVsSaPvRFs4v3GODBYFRKUnsN7
SBdt5m/odVhr/h6unkEx7WUjX63togjMfPCpRqUwSfKtu8TIqjdazw==
-----END CERTIFICATE-----
EOFCERT

# -----------------------------------------------------------------------------
# CONFIGURATION NGINX
# -----------------------------------------------------------------------------

# Configuration Nginx pour écouter en HTTPS (443) et forcer TLS 1.2
cat > /etc/nginx/sites-available/default <<EOF
server {
    listen 80;
    listen 443 ssl;
    
    # Chemins vers les fichiers créés ci-dessus
    ssl_certificate /etc/nginx/ssl/nginx.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.key;
    
    # SÉCURITÉ : Forcer TLS 1.2 uniquement
    ssl_protocols TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        add_header Content-Type text/plain;
        return 200 'Backend TLS 1.2 valid certificate :) Nice.';
    }
}
EOF

# 3. Redémarrage pour appliquer la config
systemctl restart nginx