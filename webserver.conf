#!/bin/bash
# Mise à jour et installation des outils
apt-get update
apt-get install -y nginx python3-pip

# Installation de Certbot et du plugin DNS GoDaddy
pip3 install certbot certbot-dns-godaddy

# Configuration des credentials GoDaddy (Sécurisé)
mkdir -p /root/.secrets
cat > /root/.secrets/godaddy.ini <<EOF
dns_godaddy_key = ${godaddy_key}
dns_godaddy_secret = ${godaddy_secret}
EOF
chmod 600 /root/.secrets/godaddy.ini

# Génération d'un certificat Self-Signed temporaire (Fallback)
# Cela garantit que Nginx démarre même si Let's Encrypt échoue
mkdir -p /etc/nginx/ssl
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/nginx/ssl/nginx.key \
    -out /etc/nginx/ssl/nginx.crt \
    -subj "/CN=${domain_name}"

# Configuration Nginx Initiale (Self-Signed)
cat > /etc/nginx/sites-available/default <<EOF
server {
    listen 80;
    listen 443 ssl;
    server_name ${domain_name};
    
    ssl_certificate /etc/nginx/ssl/nginx.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx.key;
    
    ssl_protocols TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        add_header Content-Type text/plain;
        return 200 'Backend en ligne (Certificat: Self-Signed temporaire)';
    }
}
EOF
systemctl restart nginx

# Tentative d'obtention du certificat Let's Encrypt (Challenge DNS)
# Si les clés API sont valides, cela va générer les certs dans /etc/letsencrypt/live/...
if [ -n "${godaddy_key}" ] && [ -n "${godaddy_secret}" ]; then
    echo "Tentative Certbot..."
    certbot certonly \
      --non-interactive \
      --agree-tos \
      --email ${email} \
      --dns-godaddy \
      --dns-godaddy-credentials /root/.secrets/godaddy.ini \
      --dns-godaddy-propagation-seconds 60 \
      -d ${domain_name}
      
    # Si succès, on met à jour Nginx pour utiliser le vrai certificat
    if [ -f /etc/letsencrypt/live/${domain_name}/fullchain.pem ]; then
        cat > /etc/nginx/sites-available/default <<EOF
server {
    listen 80;
    listen 443 ssl;
    server_name ${domain_name};

    ssl_certificate /etc/letsencrypt/live/${domain_name}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${domain_name}/privkey.pem;
    
    ssl_protocols TLSv1.2;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        add_header Content-Type text/plain;
        return 200 'Succès ! Backend sécurisé avec Let\'s Encrypt.';
    }
}
EOF
        systemctl reload nginx
    fi
fi