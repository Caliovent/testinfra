Content-Type: multipart/mixed; boundary="==AZURE=="
MIME-Version: 1.0

--==AZURE==
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0

config system global
set hostname "${hostname}"
set admin-sport 8443
end

config system settings
    set gui-load-balance enable
    set gui-explicit-proxy enable
    set gui-waf-profile enable
    set gui-multiple-interface-policy enable
end

# Loopback for Floating IP acceptance
config system interface
    edit port1
        set alias public
        set mode dhcp
        set allowaccess ping https ssh fgfm probe-response
        set src-check disable
    next
    edit port2
        set alias private
        set mode dhcp
        set allowaccess ping https ssh fgfm probe-response
        set defaultgw disable
        set src-check disable
    next
end

config router static
    edit 1
        set gateway 10.1.0.1
        set device "port1"
    next
    edit 2
        set dst 168.63.129.16 255.255.255.255
        set gateway 10.1.1.1
        set device "port2"
    next
end

config system probe-response
    set mode http-probe
    set http-probe-value OK
    set port 8008
end
config vpn certificate ca
    edit "CA_Intermediate"
        set certificate "${cert_intermediate}"
    next
end

config vpn certificate local
    edit "Shared_Frontend_Cert"
        set certificate "${cert_body}"
        set private-key "${cert_key}"
    next
end


# Local-In Policies
config firewall address
    edit "AzureLBProbe"
        set subnet 168.63.129.16 255.255.255.255
    next
end
config firewall service custom
    edit "HealthProbe-8008"
        set tcp-portrange 8008
    next
end
config firewall local-in-policy
    edit 1
        set intf "port1"
        set srcaddr "AzureLBProbe"
        set dstaddr "all"
        set service "HealthProbe-8008"
        set schedule "always"
        set action accept
    next
    edit 2
        set intf "port2"
        set srcaddr "AzureLBProbe"
        set dstaddr "all"
        set service "HealthProbe-8008"
        set schedule "always"
        set action accept
    next
end


config firewall vip
    edit "originazwww-http-vs"
        set type server-load-balance
        set extip ${vip_ip}
        set extintf "port1"
        set server-type tcp
        set extport 80
        set mappedport 80
        config realservers
            edit 1
                set ip ${backend_ip}
                set port 80
            next
        end
    next

    edit "originazwww-https-vs"
        set type server-load-balance
        set extip ${vip_ip}
        set extintf "port1"
        set server-type https
        set extport 443
        set mappedport 443
        set ssl-certificate "Shared_Frontend_Cert"
        config realservers
            edit 1
                set ip ${backend_ip}
                set port 443
            next
        end
    next
end


# SSL Profile
config firewall ssl-ssh-profile
    edit "allow-invalid-server-cert"
        config ssl
            set server-cert-mode allow
        end
    next
end


config firewall policy
    edit 1
        set name "vip-policy"
        set srcintf "port1"
        set dstintf "port2"
        set action accept
        set srcaddr "all"
        set dstaddr "originazwww-https-vs" "originazwww-http-vs"
        set schedule "always"
        set service "HTTP" "HTTPS"
        set inspection-mode flow
        set ssl-ssh-profile "allow-invalid-server-cert"
        set nat enable
        set logtraffic all
    next
end



# --- POLICY HTTPS ---
config firewall policy
    edit 2
        set name "afd-to-backend-https"
        set srcintf "port1"
        set dstintf "port2"
        set action accept
        set srcaddr "all"
        set dstaddr "originazwww-https-vs"
        set schedule "always"
        set service "HTTPS"
        set utm-status enable
        set ssl-ssh-profile "certificate-inspection"
        set nat enable
    next
end
%{ if type == "byol" }
--==AZURE==
Content-Type: text/plain; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="license"

${file(license_file)}

%{ endif }
--==AZURE==--